<turbo-frame id="main-product-<%= product.id %>" target="_top">
  <% current_variant = @selected_variant || @variant_from_options || product.first_or_default_variant(current_currency) %>
  <div class="main-product-container" style="<%= section_styles(section) %>">
    <div
      class="page-container lg:mb-16"
      <%= 'data-controller=product-form' %>
      data-product-form-required-options-value='<%= product.option_type_ids.map(&:to_s).to_json %>'
      data-product-form-selected-variant-disabled-value='<%= !@selected_variant&.in_stock? %>'
      data-product-form-variant-from-options-disabled-value='<%= !@variant_from_options&.in_stock? %>'
      data-product-form-frame-name-value="main-product-<%= product.id %>"
      data-product-form-url-value="<%= spree.product_url(product) %>">
      <template data-product-form-target="spinnerTemplate">
        <%= render "spree/shared/icons/spinner" %>
      </template>

      <div id="product-details-page">
        <% images = product_media_gallery_images(product, selected_variant: @selected_variant, variant_from_options: @variant_from_options) %>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-x-8 lg:gap-x-12 items-start">
          <%# Left Column - Product Images %>
          <div class="lg:col-span-7 relative">
            <div class="lg:hidden mb-6">
              <%= render 'spree/products/media_gallery', images: images, product: product %>
            </div>
            <div class="hidden lg:block" data-product-form-target="desktopMediaGallery">
              <%= render 'spree/products/media_gallery', images: images, desktop: true, product: product %>
            </div>
          </div>

          <%# Right Column - Product Details %>
          <div class="lg:col-span-5 lg:col-start-8 flex flex-col h-full">
            <% show_waitlist_modal = spree.respond_to?(:waitlists_path) && current_variant.present? %>
            <div
              <% if show_waitlist_modal %>
              data-controller="modal"
              <% end %>
              data-modal-allow-background-close="true"
              class="h-full w-full waitlist-modal"
              data-modal-backdrop-color-value="rgba(0,0,0,0.32)">
              <%= form_with(url: spree.line_items_path, method: :post, data: { controller: "turbo-stream-form", product_form_target: "form" }) do |f| %>
                <%= hidden_field_tag :variant_id, current_variant&.id %>

                <div data-product-form-target="productDetails" class="product-details-ecommerce">
                  <%# Title %>
                  <% section.blocks.each do |block| %>
                    <% next unless block.class.name == 'Spree::PageBlocks::Products::Title' %>
                    <h1 class="text-2xl lg:text-3xl font-semibold mb-3 text-gray-900">
                      <%= product.name %>
                    </h1>
                  <% end %>

                  <%# Rating and Reviews %>
                  <div class="flex items-center gap-3 mb-4">
                    <div class="flex items-center gap-1">
                      <% avg_rating = product.average_rating %>
                      <span class="text-lg font-semibold text-gray-900"><%= number_with_precision(avg_rating, precision: 1) %></span>
                      <div class="flex items-center gap-0.5">
                        <% 5.times do |i| %>
                          <span class="text-orange-500 text-lg leading-none">
                            <% if i < avg_rating.floor %>
                              ★
                            <% elsif i < avg_rating.ceil && avg_rating % 1 >= 0.5 %>
                              ★
                            <% else %>
                              ☆
                            <% end %>
                          </span>
                        <% end %>
                      </div>
                    </div>
                    <span class="text-sm text-gray-600">
                      <%= product.reviews_count %> <%= Spree.t('storefront.reviews.reviews', default: 'Değerlendirme') %>
                    </span>
                  </div>

                  <%# Price Section %>
                  <% section.blocks.each do |block| %>
                    <% next unless block.class.name == 'Spree::PageBlocks::Products::Price' %>
                    <% price = current_variant&.price_in(current_currency) || product.price_in(current_currency) %>
                    <div class="mb-6">
                      <% if price.compare_at_amount.present? && price.compare_at_amount > price.amount %>
                        <div class="mb-2">
                          <span class="text-3xl font-bold text-green-600"><%= price.display_amount %></span>
                          <span class="text-lg text-gray-500 line-through ml-2"><%= price.display_compare_at_amount %></span>
                        </div>
                        <% savings = price.compare_at_amount - price.amount %>
                        <% savings_money = Spree::Money.new(savings, currency: price.currency) %>
                        <div class="inline-block px-3 py-1 bg-green-50 border border-green-200 rounded mb-2">
                          <span class="text-sm font-medium text-green-700">
                            <%= Spree.t('storefront.products.you_save', amount: savings_money.to_s, default: 'Kazancınız: %{amount}') %>
                          </span>
                        </div>
                      <% else %>
                        <div class="product-price text-3xl font-bold"><%= price.display_amount %></div>
                      <% end %>
                    </div>
                  <% end %>

                  <%# Product Features/Properties List %>
                  <% if product_properties(product).any? %>
                    <div class="mb-6 product-features">
                      <ul class="space-y-2">
                        <% product_properties(product).each do |product_property| %>
                          <li><%= product_property.value %></li>
                        <% end %>
                      </ul>
                    </div>
                  <% end %>

                  <%# Variant Picker (Color & Size) %>
                  <% section.blocks.each do |block| %>
                    <% next unless block.class.name == 'Spree::PageBlocks::Products::VariantPicker' %>
                    <div class="mb-6">
                      <%= render 'spree/products/variant_picker', product: product, selected_variant: @selected_variant %>
                    </div>
                  <% end %>

                  <%# Quantity Selector %>
                  <% section.blocks.each do |block| %>
                    <% next unless block.class.name == 'Spree::PageBlocks::Products::QuantitySelector' %>
                    <div class="mb-6">
                      <%= render 'spree/products/quantity_selector', product: product, selected_variant: @selected_variant %>
                    </div>
                  <% end %>

                  <%# Add to Cart Button with Icons %>
                  <% section.blocks.each do |block| %>
                    <% next unless block.class.name == 'Spree::PageBlocks::Products::BuyButtons' %>
                    <div class="mb-6" data-controller='sticky-button'>
                      <div class="flex items-center gap-3">
                        <div class="flex-1">
                          <%= render 'spree/products/add_to_cart_button', product: product, selected_variant: @selected_variant, sticky_button_classes: "w-full" %>
                        </div>
                        <div class="flex items-center gap-2">
                          <%= render 'spree/products/add_to_wishlist', variant: current_variant, css_classes: 'btn-icon btn--wishlist p-3 border border-gray-300 rounded hover:border-orange-500', icon_size: 24 %>
                          <button type="button" class="btn-icon p-3 border border-gray-300 rounded hover:border-orange-500" title="<%= Spree.t('storefront.products.save', default: 'Kaydet') %>">
                            <svg class="w-6 h-6 text-gray-600 hover:text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <%# Delivery Options %>
                  <div class="mt-auto p-4 bg-gray-50 rounded border border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">
                      <%= Spree.t('storefront.products.delivery_options', default: 'Teslimat Seçenekleri') %>
                    </h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="text-gray-700">
                          <%= Spree.t('storefront.products.estimated_delivery', date: '16 Aralık Salı', default: 'Tahmini %{date} kapında') %>
                        </span>
                      </div>
                      <div class="text-xs text-gray-600">
                        <%= Spree.t('storefront.products.standard_delivery', default: 'Standart Teslimat') %>
                      </div>
                    </div>
                  </div>

                </div>
              <% end %>

              <%= render 'spree/products/add_to_waitlist', variant: current_variant if show_waitlist_modal %>
            </div>
          </div>
        </div>
        
        <%# Product Description and Product Info - Tabs below images and product details, full width %>
        <div class="mt-8 lg:mt-12 w-full" data-controller="tabs">
          <% description_block = section.blocks.find { |b| b.class.name == 'Spree::PageBlocks::Products::Description' } %>
          <% has_description = description_block && product.storefront_description.present? %>
          <% has_product_info = true %>
          
          <% if has_description || has_product_info %>
            <%# Tabs Navigation %>
            <div class="border-b border-gray-200 mb-6">
              <nav class="flex space-x-8" aria-label="Tabs">
                <% if has_description %>
                  <button
                    type="button"
                    data-tabs-target="tab"
                    data-tab-id="description"
                    data-action="click->tabs#switchTab"
                    class="border-b-2 border-orange-500 text-orange-600 font-semibold py-4 px-1 text-sm whitespace-nowrap">
                    <%= Spree.t('storefront.products.description', default: 'Açıklama') %>
                  </button>
                <% end %>
                <% if has_product_info %>
                  <button
                    type="button"
                    data-tabs-target="tab"
                    data-tab-id="product-info"
                    data-action="click->tabs#switchTab"
                    class="border-b-2 border-transparent text-gray-600 font-medium py-4 px-1 text-sm whitespace-nowrap hover:text-gray-900 hover:border-gray-300">
                    <%= Spree.t('storefront.products.product_information', default: 'Ürün Bilgileri') %>
                  </button>
                <% end %>
              </nav>
            </div>

            <%# Tab Contents %>
            <div class="w-full">
              <% if has_description %>
                <div
                  data-tabs-target="content"
                  data-tab-content="description"
                  class="product-tab-content">
                  <%= render 'spree/products/description', product: product, block: description_block, section: section %>
                </div>
              <% end %>

              <% if has_product_info %>
                <div
                  data-tabs-target="content"
                  data-tab-content="product-info"
                  class="product-tab-content hidden">
                  <div class="space-y-6">
                    <%# Product Information Table %>
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                      <div class="p-4 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-900">
                          <%= Spree.t('storefront.products.product_information', default: 'Ürün Bilgileri') %>
                        </h3>
                      </div>
                      <div class="p-4 space-y-3 text-sm">
                        <% if product.respond_to?(:gender) && product.gender.present? %>
                          <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600"><%= Spree.t('storefront.products.gender', default: 'Cinsiyet') %>:</span>
                            <span class="text-gray-900 font-medium"><%= product.gender %></span>
                          </div>
                        <% end %>
                        <% if product.taxons.any? %>
                          <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600"><%= Spree.t('storefront.products.product_type', default: 'Ürün Tipi') %>:</span>
                            <span class="text-gray-900 font-medium"><%= product.taxons.first.name.truncate(20) %></span>
                          </div>
                        <% end %>
                        <% if current_variant && current_variant.total_on_hand.present? %>
                          <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-gray-600"><%= Spree.t('storefront.products.stock_quantity', default: 'Stok Adedi') %>:</span>
                            <span class="text-gray-900 font-medium">
                              <% if current_variant.total_on_hand < 5 %>
                                <%= Spree.t('storefront.products.less_than_5', default: '5 adetten az') %>
                              <% else %>
                                <%= current_variant.total_on_hand %> <%= Spree.t('storefront.products.items', default: 'adet') %>
                              <% end %>
                            </span>
                          </div>
                        <% end %>
                        <div class="flex justify-between py-2">
                          <span class="text-gray-600"><%= Spree.t('storefront.products.warranty', default: 'Garanti Süresi (Ay)') %>:</span>
                          <span class="text-gray-900 font-medium">1</span>
                        </div>
                      </div>
                    </div>

                    <%# Additional Product Properties %>
                    <% fit_features = product.property('fit_features') || product.property('fit_and_features') %>
                    <% fabric = product.property('fabric') %>
                    <% materials_care = product.property('materials_care') || product.property('care_instructions') %>
                    
                    <% if fit_features.present? %>
                      <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                          <h3 class="text-sm font-semibold text-gray-900">
                            <%= Spree.t('storefront.products.fit_features', default: 'FIT & FEATURES') %>
                          </h3>
                        </div>
                        <div class="p-4 text-sm text-gray-700 leading-relaxed">
                          <%= simple_format(fit_features) %>
                        </div>
                      </div>
                    <% end %>

                    <% if fabric.present? %>
                      <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                          <h3 class="text-sm font-semibold text-gray-900">
                            <%= Spree.t('storefront.products.fabric', default: 'FABRIC') %>
                          </h3>
                        </div>
                        <div class="p-4 text-sm text-gray-700 leading-relaxed">
                          <%= simple_format(fabric) %>
                        </div>
                      </div>
                    <% end %>

                    <% if materials_care.present? %>
                      <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                          <h3 class="text-sm font-semibold text-gray-900">
                            <%= Spree.t('storefront.products.materials_care', default: 'MATERIALS & CARE') %>
                          </h3>
                        </div>
                        <div class="p-4 text-sm text-gray-700 leading-relaxed">
                          <%= simple_format(materials_care) %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Reviews Section - Below tabs, always visible %>
        <div class="mt-12 w-full">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">
              <%= Spree.t('storefront.reviews.title', default: 'Değerlendirmeler') %>
            </h2>
            <% if product.reviews_count > 0 %>
              <p class="text-sm text-gray-600">
                <%= product.reviews_count %> <%= Spree.t('storefront.reviews.reviews', default: 'değerlendirme') %>
              </p>
            <% end %>
          </div>
          <%= render 'spree/products/reviews', product: product %>
        </div>
      </div>
    </div>
  </div>
  <%= render 'spree/products/json_ld', product: product, selected_variant: @selected_variant %>
</turbo-frame>
